<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Cat Classifier™ Upload</title>
</head>
<body>
  <h1>Cat Classifier</h1>
  <input type="file" id="fileInput" />
  <button onclick="uploadFile()">Upload Image</button>
  <p id="status"></p>
  <p id="result"></p>

  <div id="custom-cat-form" style="display: none; margin-top: 20px;">
    <p>This cat species is still undiscovered...</p>
    <label for="userCatName">Name it yourself:</label>
    <input type="text" id="userCatName" placeholder="e.g. Cat that carries stuff" />
    <button onclick="submitCustomCat()">Name This Cat</button>
  </div>

  <!-- Load AWS SDK -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1192.0.min.js"></script>
  <script>
    // Cognito identity pool
    AWS.config.region = 'us-east-1';
    AWS.config.credentials = new AWS.CognitoIdentityCredentials({
      IdentityPoolId: 'us-east-1:23234a8c-ee12-409e-b4e3-217bddb574f2'
    });

    const bucketName = 'my-catclassifier23234';
    const s3 = new AWS.S3({ params: { Bucket: bucketName } });

    let currentOriginalLabel = null;
    let uploadedFileName = null;

    function uploadFile() {
      const file = document.getElementById('fileInput').files[0];
      const status = document.getElementById('status');
      const result = document.getElementById('result');
      const form = document.getElementById('custom-cat-form');
      form.style.display = 'none';
      currentOriginalLabel = null;
      uploadedFileName = null;

      if (!file) {
        status.innerText = 'Please select a file.';
        result.innerText = '';
        return;
      }

      uploadedFileName = file.name;

      const params = {
        Key: file.name,
        Body: file,
        ContentType: file.type,
        ACL: 'private'
      };

      s3.putObject(params, function (err, data) {
        if (err) {
          status.innerText = 'Upload failed: ' + err.message;
          result.innerText = '';
        } else {
          status.innerText = 'File uploaded successfully!';
          result.innerText = 'Classifying... please wait...';

          // Delayed fetch of classification result
          setTimeout(() => {
            fetch(`https://7rfw4qw9pl.execute-api.us-east-1.amazonaws.com/prod/results?image=${uploadedFileName}`)
              .then(res => res.json())
              .then(data => {
                console.log("API response:", data);

                const match = data.find(item => item.image_key === uploadedFileName);
                if (!match) {
                  result.innerText = 'Result not found for this image.';
                  return;
                }

                const message = match.catified_result;
                result.innerText = `Result: ${message}`;

                if (message.includes("but still a cat species—just undiscovered")) {
                  currentOriginalLabel = match.original_labels;
                  form.style.display = 'block';
                }
              })
              .catch(err => {
                result.innerText = 'Could not fetch result.';
                console.error(err);
              });
          }, 4000);
        }
      });
    }

    async function submitCustomCat() {
      const userLabel = document.getElementById("userCatName").value;
      if (!userLabel || !currentOriginalLabel) {
        alert("Please enter a name for the cat species.");
        return;
      }

      const response = await fetch("https://7rfw4qw9pl.execute-api.us-east-1.amazonaws.com/prod/define-label", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          OriginalLabel: currentOriginalLabel,
          UserDefinedLabel: userLabel
        })
      });

      if (response.ok) {
        alert("Thanks! Your cat species has been saved.");
        document.getElementById("custom-cat-form").style.display = "none";
        document.getElementById("userCatName").value = "";
      } else {
        alert("Something went wrong. Try again later.");
      }
    }
  </script>
</body>
</html>
